(window.ansFrontendRelayWebpackJsonpFunction=window.ansFrontendRelayWebpackJsonpFunction||[]).push([["lib-broadcast"],{"4JlD":function(e,t,s){"use strict";var n=function(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}};e.exports=function(e,t,s,a){return t=t||"&",s=s||"=",null===e&&(e=undefined),"object"===typeof e?o(r(e),(function(r){var a=encodeURIComponent(n(r))+s;return i(e[r])?o(e[r],(function(e){return a+encodeURIComponent(n(e))})).join(t):a+encodeURIComponent(n(e[r]))})).join(t):a?encodeURIComponent(n(a))+s+encodeURIComponent(n(e)):""};var i=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)};function o(e,t){if(e.map)return e.map(t);for(var s=[],n=0;n<e.length;n++)s.push(t(e[n],n));return s}var r=Object.keys||function(e){var t=[];for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.push(s);return t}},VHT1:function(e,t,s){"use strict";s.r(t),s.d(t,"getID",(function(){return _})),s.d(t,"setID",(function(){return b})),s.d(t,"processBroadcastData",(function(){return g})),s.d(t,"hashQueryHashWithVars",(function(){return k})),s.d(t,"Broadcast",(function(){return T})),s.d(t,"collectLiveCategories",(function(){return q}));var n=s("J4zp"),i=s.n(n),o=s("SKAY"),r=s("8lmh"),a=s("Pp7N"),c=s("peAK"),l=s("mVMq"),d=s("ZXlt"),h=s("J7yc"),u=s("sEfC"),f=s.n(u),y=s("qy3/"),p=s("h39y");const _=()=>T.id,b=e=>{T.id||(T.id=e)},g=e=>{const t=e.categoryToDepkeys,s=e.depkeyToVersion,n=e.dirtiedDepkeyToVersion;t&&a.c.dispatch({type:a.a.LIVE_CATEGORY_TO_DEPKEYS_RECEIVED,payload:{categoryToDepkeys:t}}),s&&a.c.dispatch({type:a.a.DEPKEYS_RECEIVED,payload:{depkeyToVersion:s,ignoreNewDepkey:!1}}),n&&a.c.dispatch({type:a.a.DEPKEYS_RECEIVED,payload:{depkeyToVersion:n,ignoreNewDepkey:!0}})},k=e=>{let t=e.queryHash,s=e.variables;const n=Object(y.b)(s);return`${t}:${JSON.stringify(n,Object.keys(n).sort())}`},v=e=>e.split(":",3).join(":"),m=e=>{var t,s,n,i,o,r,a;return e["default"]&&(e=e["default"]),"Request"===(null===(t=e)||void 0===t?void 0:t.kind)?e:"Fragment"!==(null===(s=e)||void 0===s?void 0:s.kind)?null:null===(n=e)||void 0===n||null===(i=n.metadata)||void 0===i||null===(o=i.reloadable)||void 0===o||null===(r=o.operation)||void 0===r||null===(a=r.queryOrNull)||void 0===a?void 0:a.call(r)};class T{constructor(){this.depkeyToVersion=void 0,this.depkeyToCategories=void 0,this.queryHashToGqlQuery=void 0,this.categoryToGqlQueries=void 0,this.pendingGqlQueries=void 0,this.debounceExecutePendingGqlQueries=void 0,this.depkeyToVersion={},this.depkeyToCategories={},this.queryHashToGqlQuery={},this.categoryToGqlQueries={},this.pendingGqlQueries={},this.debounceExecutePendingGqlQueries=f()(async()=>{const e=this.pendingGqlQueries;this.pendingGqlQueries={},await this._executeGqlQueries(e)},300);const e=Object(o.getSetting)("broadcastId"),t=Object(o.getSetting)("tchannelData");null===T.id&&e&&(T.id=e),t&&Object(d.start)(t),Object(d.setBeforeReconnectionFn)(this.refreshStaleDepkeys.bind(this)),Object(d.subscribe)("broadcastReloadDirtiedDepkeys",e=>{if(!e.dirtied_depkeys)return;const t={};for(const n of e.dirtied_depkeys){var s=i()(n,2);const e=s[0],o=s[1];t[e]=o}this.processDepkeyToNewVersion(t)}),a.c.subscribe(a.a.LIVE_CATEGORY_TO_DEPKEYS_RECEIVED,e=>{var t;if(!e||!("payload"in e))return;const s=(null!==(t=e.payload)&&void 0!==t?t:{}).categoryToDepkeys;s&&this.processCategoryToDepkeys(s)}),a.c.subscribe(a.a.DEPKEYS_RECEIVED,e=>{var t;if(!e||!("payload"in e))return;const s=null!==(t=e.payload)&&void 0!==t?t:{},n=s.depkeyToVersion,i=s.ignoreNewDepkey,o=void 0!==i&&i;n&&this.updateDepkeyToNewVersion(n,o)}),Object(h.a)("WEBNODE_BROADCAST_DIRTIED_DEPKEYS",e=>{var t;if(!e||!("payload"in e))return;const s=null===(t=e.payload)||void 0===t?void 0:t.dirtied_depkeys;if(!s)return;const n={};for(const r of s){var o=i()(r,2);const e=o[0],t=o[1];n[e]=t}this.processDepkeyToNewVersion(n,!1,!0)})}updateDepkeyToNewVersion(e){let t=arguments.length>1&&arguments[1]!==undefined&&arguments[1];for(const s in e){const n=this.depkeyToVersion[s];if(n===undefined&&t)continue;const i=e[s];(n===undefined||i>n)&&(this.depkeyToVersion[s]=i)}}processDepkeyToNewVersion(e){let t=arguments.length>1&&arguments[1]!==undefined&&arguments[1],s=arguments.length>2&&arguments[2]!==undefined&&arguments[2];if(!e)return;const n={};for(const i in e){const o=this.depkeyToVersion[i];if(o===undefined&&s)continue;const r=e[i];if(t||o===undefined||!(r<=o)){this.depkeyToVersion[i]=r;for(const e in this.depkeyToCategories[i])for(const t in this.categoryToGqlQueries[e]){if(t in n)continue;const s=this.categoryToGqlQueries[e][t];n[t]=s}}}this.executeGqlQueries(n)}processCategoryToDepkeys(e){if(0!==Object.keys(e).length)for(const t in e){const s=v(t);for(const n of e[t])n in this.depkeyToCategories||(this.depkeyToCategories[n]={}),this.depkeyToCategories[n][s]=!0}}async _executeGqlQueries(e){if(0===Object.keys(e).length||Object(o.getSetting)("broadcastDisabled"))return;const t=[];for(const s in e){const n=e[s],i=n.queryHash,o=n.variables;if(!i)continue;const r=this.queryHashToGqlQuery[i];r&&t.push({query:r,variables:o})}await Promise.all(t.map(e=>{let t=e.query,s=e.variables;return Object(p.fetchQuery_DEPRECATED)(c["default"],t,s)}))}async executeGqlQueries(e){for(const t in e)t in this.pendingGqlQueries||(this.pendingGqlQueries[t]=e[t]);await this.debounceExecutePendingGqlQueries()}async refreshStaleDepkeys(e){var t;let s;try{s=await Object(l.a)("/api/get_stale_deps_POST",{json:JSON.stringify({args:[],kwargs:{dependency_to_version:this.depkeyToVersion}})})}catch(h){return}if(Object(y.f)(null===(t=s)||void 0===t?void 0:t.value))return;const n=s.value,i=n.minSeq,o=n.broadcast_id,r=n.channelHash,a=n.netloc,c=n.targetUrl,d=n.depkeys;T.id=o,this.processDepkeyToNewVersion(d,!0),e({minSeq:i,channel:o,channelHash:r,boxName:a,targetUrl:c})}async registerQuery(e,t,s){const n=(e=>{var t,s;return e["default"]&&(e=e["default"]),"Request"===(null===(t=e)||void 0===t?void 0:t.kind)?null===(s=e)||void 0===s?void 0:s.fragment:e})(e),i=m(e);if(n&&i&&s)try{const e=i.hash;this.queryHashToGqlQuery[e]=i;const o={queryHash:e,variables:t},r=await k(o),a=q(n.selections,s,{});Object.keys(a).forEach(e=>{e in this.categoryToGqlQueries||(this.categoryToGqlQueries[e]={}),r in this.categoryToGqlQueries[e]||(this.categoryToGqlQueries[e][r]=o)})}catch(o){Object(r.logJsError)("broadcast->registerQuery",o,{originalError:o})}}async deregisterQuery(e,t){const s=m(e);if(s)try{const e=s.hash,n=await k({queryHash:e,variables:t});for(const t of Object.keys(this.categoryToGqlQueries))n in this.categoryToGqlQueries[t]&&delete this.categoryToGqlQueries[t][n]}catch(n){Object(r.logJsError)("broadcast->deregisterQuery",n,{originalError:n})}}}T.id=null;const q=(e,t,s)=>{if(!t||"object"!==typeof t||t.constructor!==Object)return s;const n=t.id,i=t.__typename;return e.forEach(e=>{switch(e.kind){case"Condition":case"InlineFragment":return void q(e.selections,t,s);case"ScalarField":case"LinkedField":{const o=e.name,r=e.alias?e.alias:e.name,a=t[r];if("id"===o||"__typename"===o||null===a||a===undefined)return;if(e.selections)if(Array.isArray(a))for(const t of a)q(e.selections,t,s);else q(e.selections,a,s);if(n===undefined||null===n||!i||!e.isLive)return;s[`${i}:${o}:${n}`]=!0}}}),s}},ZXlt:function(e,t,s){"use strict";s.r(t),s.d(t,"start",(function(){return u})),s.d(t,"setBeforeReconnectionFn",(function(){return f})),s.d(t,"subscribe",(function(){return y}));var n=s("8lmh"),i=s("mF64"),o=s("s4NR"),r=s.n(o),a=s("Tm8E"),c=s("YS7e");const l=new a.a;let d,h=null;const u=e=>{null===h&&e&&!Object(c.a)()&&"WebSocket"in window&&(h=new b(e),h.start())},f=e=>{d=e},y=(e,t)=>{l.on("tchannel_message",(s,n)=>{e===s&&n&&t(n)})},p=function(e,t){let s=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;const n="https:"===Object(i.b)().protocol?"wss:":"ws:";return s?n+"//"+s:[n,"//tch",Math.floor(1e6*Math.random())+1,".tch.",e,"/up/",t,"/updates?"].join("")},_=e=>{try{const t=JSON.parse(e),s=t.message_type,i=t.payload;if(!s||!i)return void Object(n.logJsError)("lib/tchannelClient:_processMessage","Malformed message data (missing message_type and/or payload): "+e);l.trigger("tchannel_message",[s,i])}catch(t){Object(n.logJsError)("lib/tchannelClient:_processMessage","A message is not in JSON format: "+e,{originalError:t})}};class b{constructor(e){let t;this._minSeq=void 0,this._channel=void 0,this._channelHash=void 0,this._boxName=void 0,this._baseHost=void 0,this._targetUrl=void 0,this._socket=void 0,this._isActive=void 0,this._backOffTime=void 0,this._maxBackOffTime=void 0,this._isConnected=void 0,this._minSeq=e.minSeq,this._channel=e.channel,this._channelHash=e.channelHash,this._boxName=e.boxName,this._baseHost=e.baseHost;var s=e.targetUrl;t=void 0===s?null:s,this._minSeq=this._minSeq?parseInt(this._minSeq):0,this._baseHost&&this._boxName&&(this._targetUrl=p(this._baseHost,this._boxName,t)),this._socket=null,this._isActive=!1,this._backOffTime=1e3,this._maxBackOffTime=3e4,window.addEventListener("online",()=>{this._connectWebSocket(!0)}),window.addEventListener("offline",()=>{this._isConnected=!1,this._closeWebSocket()})}start(){this._isActive=!0,this._connectWebSocket()}stop(){this._isActive=!1}_updateBackOffTime(){arguments.length>0&&arguments[0]!==undefined&&arguments[0]&&(this._backOffTime=500),this._backOffTime=Math.min(2*this._backOffTime,this._maxBackOffTime)}_connectWebSocket(){let e=arguments.length>0&&arguments[0]!==undefined&&arguments[0];setTimeout(()=>{null===this._socket&&(e&&d?d(this._makeWebSocketRequest.bind(this)):this._makeWebSocketRequest())},this._backOffTime)}_closeWebSocket(){null!==this._socket&&(this._socket.close(1e3),this._socket=null)}_makeWebSocketRequest(){let e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};const t=e.minSeq,s=e.channel,n=e.channelHash,i=e.boxName,o=e.targetUrl;this._minSeq=t!==undefined?parseInt(t):this._minSeq,this._channel=s||this._channel,this._channelHash=n||this._channelHash,this._boxName=i||this._boxName,this._boxName&&this._baseHost&&(this._targetUrl=p(this._baseHost,this._boxName,o));const a=`${this._targetUrl}${r.a.stringify({min_seq:this._minSeq,channel:this._channel,hash:this._channelHash})}`;try{this._socket=new window.WebSocket(a)}catch(c){return void this._onError()}this._socket.onclose=e=>{this._isConnected&&(this._isConnected=!1,this._connectWebSocket(!0))},this._socket.onerror=e=>{this._closeWebSocket(),this._onError()},this._socket.onmessage=e=>{this._onReceivedResponse(JSON.parse(e.data))}}_onReceivedResponse(e){if(this._isActive){this._updateBackOffTime(!0),this._isConnected=!0;try{if(e.error)throw e.error;this._minSeq=parseInt(e.min_seq);for(const t of e.messages)_(t)}catch(t){return}}}_onError(){setTimeout(()=>{this._isActive&&this._updateBackOffTime()},0)}}},kd2E:function(e,t,s){"use strict";function n(e,t){return Object.prototype.hasOwnProperty.call(e,t)}e.exports=function(e,t,s,o){t=t||"&",s=s||"=";var r={};if("string"!==typeof e||0===e.length)return r;var a=/\+/g;e=e.split(t);var c=1e3;o&&"number"===typeof o.maxKeys&&(c=o.maxKeys);var l=e.length;c>0&&l>c&&(l=c);for(var d=0;d<l;++d){var h,u,f,y,p=e[d].replace(a,"%20"),_=p.indexOf(s);_>=0?(h=p.substr(0,_),u=p.substr(_+1)):(h=p,u=""),f=decodeURIComponent(h),y=decodeURIComponent(u),n(r,f)?i(r[f])?r[f].push(y):r[f]=[r[f],y]:r[f]=y}return r};var i=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)}},s4NR:function(e,t,s){"use strict";t.decode=t.parse=s("kd2E"),t.encode=t.stringify=s("4JlD")}}]);